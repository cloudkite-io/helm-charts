# Load Balancer Naming:
# - Default: Auto-generates as {db-name}-lb (max 32 chars, truncated if needed)
# - Per-database override: Set loadBalancerName on individual databases
#   Final LB name will be: {db-name}-{loadBalancerName}
# - Global override (optional): Uncomment to set default suffix for all databases
#   loadBalancerName: mssql-load-balancer

# Global image configuration
image:
  repository: gcr.io/cloudkite-public/mssql
  tag: "2022"
  pullPolicy: IfNotPresent

databases:
  - name: db-a
    database: db_a
    port: 1433
    storage: 50Gi
    secretName: db-a-db-secret
    secretKey: sa-password
    edition: Developer
    # Optional: Override the auto-generated LB name
    # Without this, LB name would be: db-a-lb
    # With this override, LB name will be: db-a-mssql-lb
    loadBalancerName: mssql-lb
    externalSecrets:
      - name: db-secret
        secretName: kubernetes/stage-eks/db-secret
        secretStore: aws-secret-manager
    initSql: |
      CREATE DATABASE another_db;
      GO;
    resources:
      requests:
        cpu: 2
        memory: 4Gi
      limits:
        memory: 4Gi
    backup:
      enabled: true
      s3Bucket: "your-primary-backup-bucket"
      s3Region: "us-east-1"

      # Backup strategy configuration
      strategy:
        # Full backup schedule (required as base for differential)
        full:
          enabled: true
          schedule: "0 2 * * 0"  # Weekly on Sunday at 2:00 AM UTC
          retentionDays: 90       # Keep for 3 months

        # Differential backup schedule (requires full backups)
        differential:
          enabled: true
          schedule: "0 2 * * 1-6"  # Daily Mon-Sat at 2:00 AM UTC
          retentionDays: 30        # Keep for 1 month

        # Transaction log backup (optional, for point-in-time recovery)
        log:
          enabled: false
          schedule: "*/30 * * * *"  # Every 30 minutes
          retentionDays: 7          # Keep for 1 week

      image:
        repository: gcr.io/cloudkite-public/mssql
        tag: "v0.3.3"
        pullPolicy: IfNotPresent
      serviceAccount:
        create: true
        name: "db-a-backup-sa"
        # Add your IRSA role ARN annotation here
        annotations:
          eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/mssql-backup-role-for-db-a"

  - name: db-b
    database: db_b
    port: 1433
    storage: 50Gi
    secretName: db-b-db-secret
    secretKey: sa-password
    edition: Developer
    # Optional: Override the auto-generated LB name
    # Without this, LB name would be: db-b-lb
    # With this override, LB name will be: db-b-staging-lb
    loadBalancerName: staging-lb
    image:
      repository: gcr.io/cloudkite-public/mssql
      tag: "2019"
      pullPolicy: IfNotPresent
    initSql: |
      CREATE DATABASE another_db;
      GO;
    resources:
      requests:
        cpu: 2
        memory: 4Gi
      limits:
        memory: 4Gi
    backup:
      enabled: false
